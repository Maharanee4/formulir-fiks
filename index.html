<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Prediksi Kasus DBD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #1b9a96, #1e88e5); color: #fff; }
    .container { background-color: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; max-width: 1000px; margin: 50px auto; color: #000; }
    h1 { text-align: center; color: #1e88e5; }
    label { display: block; margin: 10px 0 5px; color: #333; }
    input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-bottom: 20px; border-radius: 8px; background-color: #0D47A1; color: white; border: 1px solid #0D47A1; }
    input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: #1976D2; }
    button { padding: 12px 20px; background-color: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .output, .download-buttons { display: none; margin-top: 30px; }
    .chart-container { height: 400px; position: relative; }
    canvas { width: 100% !important; height: 100% !important; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border: 1px solid #ddd; border-radius: 8px; }
    th { background-color: #0D47A1; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    tr:hover { background-color: #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://i.postimg.cc/HncHwVKh/LOGO-SIPRE-KADER-bulat.png" alt="Logo" style="max-height: 80px;" />
      <h2 style="margin: 10px 0 0; color: #1e88e5;">SiPre-KaDer</h2>
    </div>

    <h1>Formulir Prediksi Kasus DBD 6 Bulan ke Depan</h1>
    <form id="dbdForm">

      <!-- input lain tetap -->
    
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
  <i class="fa-solid fa-hospital" style="color: #0d47a1;"></i>
  <label for="puskesmas">Nama Puskesmas:</label>
</div>

<div>
  <input type="text" id="puskesmas" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
</div>

    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
  <i class="fa-regular fa-address-book" style="color: #0d47a1;"></i>
  <label for="penduduk">Jumlah Penduduk:</label>
</div> 

<div>
      <input type="number" id="penduduk" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;"  />
</div>

    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
  <i class="fa-solid fa-mosquito-net" style="color: #0d47a1;"></i>  
  <label for="kasus3bulan">Kasus DBD 3 Bulan Terakhir:</label>
</div>

<div>
      <input type="number" id="kasus3bulan" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
</div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <i class="fa-solid fa-house-flood-water-circle-arrow-right" style="color: #0d47a1;"></i>  
      <label for="genangan">Jumlah Titik Genangan Air (RT):</label>
</div>

<div>
      <input type="number" id="genangan" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
</div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <i class="fa-brands fa-medrt" style="color: #0d47a1;"></i>  
      <label for="cakupanPSN">Cakupan PSN (%):</label>
</div>

<div>
      <input type="number" id="cakupanPSN" min="0" max="100" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
</div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
      <i class="fa-solid fa-head-side-cough" style="color: #0d47a1;"></i>  
      <label for="demam">Jumlah Kasus Demam Akut 1 Bulan Terakhir:</label>
</div>

<div>
      <input type="number" id="demam" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
</div>

<!-- Input Cakupan Edukasi Lingkungan -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-school-circle-check" style="color: #0d47a1;"></i>  
        <label for="edukasi">Cakupan Edukasi Lingkungan (%):</label>
      </div>
      <div>
        <input type="number" id="edukasi" min="0" max="100" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: none; 
                      background-color: #0d47a1; color: white;" />
      </div>

      <!-- Input Jumlah Rumah Diperiksa -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-house" style="color: #0d47a1;"></i>
        <label for="rumahPeriksa">Jumlah Rumah Diperiksa:</label>
      </div>
      <div>
        <input type="number" id="rumahPeriksa" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: none; 
                      background-color: #0d47a1; color: white;" />
      </div>

      <!-- Input Jumlah Rumah Terdapat Jentik -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-bug" style="color: #0d47a1;"></i>
        <label for="rumahJentik">Jumlah Rumah dengan Jentik:</label>
      </div>
      <div>
        <input type="number" id="rumahJentik" 
               style="width: 100%; padding: 10px; border-radius: 8px; border: none; 
                      background-color: #0d47a1; color: white;" />
      </div>

      <!-- Input PSN Serentak -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-people-group" style="color: #0d47a1;"></i>
        <label for="psnSerentak">PSN Serentak?</label>
      </div>
      <div>
        <select id="psnSerentak" 
                style="width: 100%; padding: 10px; border-radius: 8px; border: none; 
                       background-color: #0d47a1; color: white;">
          <option value="" disabled selected>Pilih status PSN</option>
          <option value="1">Ya</option>
          <option value="0">Tidak</option>
        </select>
      </div>

      <!-- Input faktor iklim -->
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-cloud-rain" style="color: #0d47a1;"></i>
        <label for="curahHujan">Curah Hujan (mm/bulan):</label>
      </div>
      <div>
        <input type="number" id="curahHujan" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
      </div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-temperature-three-quarters" style="color: #0d47a1;"></i>
        <label for="suhu">Suhu Rata-rata (°C):</label>
      </div>
      <div>
        <input type="number" id="suhu" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
      </div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <i class="fa-solid fa-water" style="color: #0d47a1;"></i>
        <label for="kelembaban">Kelembaban Udara (%):</label>
      </div>
      <div>
        <input type="number" id="kelembaban" min="0" max="100" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #0d47a1; color: white;" />
      </div>

       <button type="button" id="btnProses">Proses</button>
    </form>

     <div class="output" id="output">
      <h1 style="color: #000;">Hasil Prediksi</h1>
      <h2 id="namaPuskesmas" style="color: #005f30;"></h2>
      <div id="estimasiKasus"></div>
      <p id="skorRisiko"></p>
      <p id="zonaRisiko"></p>
      <div class="chart-container">
        <canvas id="chartPrediksi"></canvas>
      </div>
    </div>

    <div class="download-buttons">
      <button id="btnPdf">Download PDF</button>
      <button id="btnExcel">Download Excel</button>
      <button id="btnGambar">Download Gambar Grafik</button>
    </div>
  </div>

  <script>
    window.onload = function () {
      document.getElementById("btnProses").addEventListener("click", prosesPrediksi);
      document.getElementById("btnPdf").addEventListener("click", downloadPDF);
      document.getElementById("btnExcel").addEventListener("click", downloadExcel);
      document.getElementById("btnGambar").addEventListener("click", downloadChartImage);
    };

    const bobotModel = {
      kasus3bulan: 0.62,
      genangan: 0.41,
      demam: 0.28,
      psn: -0.35,
      edukasi: -0.25,
      ABJ: -0.22,
      psnSerentak: -0.15,
      curahHujan: 0.12,
      suhu: 0.08,
      kelembaban: 0.15
    };

    function prosesPrediksi() {
      const bulan = ["Bulan 1", "Bulan 2", "Bulan 3", "Bulan 4", "Bulan 5", "Bulan 6"];
      const kasus3bulan = Number(document.getElementById("kasus3bulan").value);
      const genangan = Number(document.getElementById("genangan").value);
      const demam = Number(document.getElementById("demam").value);
      const psn = Number(document.getElementById("cakupanPSN").value);
      const edukasi = Number(document.getElementById("edukasi").value);
      const rumahPeriksa = Number(document.getElementById("rumahPeriksa").value);
      const rumahJentik = Number(document.getElementById("rumahJentik").value);
      const psnSerentak = document.getElementById("psnSerentak").value;
      const curahHujan = Number(document.getElementById("curahHujan").value);
      const suhu = Number(document.getElementById("suhu").value);
      const kelembaban = Number(document.getElementById("kelembaban").value);

      let HI = rumahPeriksa > 0 ? (rumahJentik / rumahPeriksa) * 100 : 0;
      let ABJ = 100 - HI;

      let basePrediksi = (
        (kasus3bulan * bobotModel.kasus3bulan) +
        (genangan * bobotModel.genangan) +
        (demam * bobotModel.demam) +
        (psn * bobotModel.psn) +
        (edukasi * bobotModel.edukasi) +
        (ABJ * bobotModel.ABJ) +
        (psnSerentak === "1" ? bobotModel.psnSerentak : 0) +
        (curahHujan * bobotModel.curahHujan) +
        (suhu * bobotModel.suhu) +
        (kelembaban * bobotModel.kelembaban)
      );

      const faktorMusiman = [1.1, 1.05, 0.95, 0.9, 1.2, 1.15];
      let prediksi = bulan.map((_, i) => Math.max(0, Math.round(basePrediksi * faktorMusiman[i])));
      const ciBawah = prediksi.map(p => Math.max(0, p - 5));
      const ciAtas = prediksi.map(p => p + 5);

      let skor = Math.max(0, Math.round(basePrediksi * 2));
      let zona = skor >= 60 ? "Zona Merah (Darurat)" : skor >= 30 ? "Zona Kuning (Rentan)" : "Zona Hijau (Aman)";
      let warnaZona = skor >= 60 ? "red" : skor >= 30 ? "orange" : "green";

      document.getElementById('output').style.display = 'block';
      document.querySelector('.download-buttons').style.display = 'flex';

      const estimasiTotal = prediksi.reduce((a, b) => a + b, 0);
      let tabelEstimasi = "<table><thead><tr><th>Bulan</th><th>Prediksi Kasus</th></tr></thead><tbody>";
      prediksi.forEach((val, idx) => {
        tabelEstimasi += `<tr><td>Bulan ${idx + 1}</td><td>${val}</td></tr>`;
      });
      tabelEstimasi += "</tbody></table>";

      document.getElementById('estimasiKasus').innerHTML =
        `<p style="color:black; font-weight:bold;">Estimasi Total Kasus: ${estimasiTotal} kasus</p>
         <p style="color:black; font-weight:bold;">Estimasi per Bulan:</p>${tabelEstimasi}`;
      document.getElementById('skorRisiko').innerHTML = `<span style="color: black;">Skor Risiko: ${skor}</span>`;
      document.getElementById('zonaRisiko').innerHTML = `<span style="color: ${warnaZona}; font-weight: bold;">Status Zona: ${zona}</span>`;

      const ctx = document.getElementById('chartPrediksi').getContext('2d');
      if (window.chartInstance) window.chartInstance.destroy();
      window.chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: bulan,
          datasets: [
            { label: 'Prediksi Kasus', data: prediksi, borderColor: 'blue', fill: false },
            { label: 'CI Atas (95%)', data: ciAtas, borderColor: 'green', borderDash: [5, 5], fill: false },
            { label: 'CI Bawah (95%)', data: ciBawah, borderColor: 'red', borderDash: [5, 5], fill: false }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Prediksi Kasus DBD Selama 6 Bulan' } },
          scales: {
            y: { title: { display: true, text: 'Jumlah Kasus' } },
            x: { title: { display: true, text: 'Bulan' } }
          }
        }
      });

      window.prediksiData = { bulan, prediksi, ciBawah, ciAtas, skor, zona };
    }

    // ✅ fungsi download sudah lengkap
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Laporan Prediksi Kasus DBD", 14, 20);
      doc.setFontSize(12);
      doc.text(`Skor Risiko: ${window.prediksiData.skor}`, 14, 30);
      doc.text(`Zona: ${window.prediksiData.zona}`, 14, 38);

      const body = window.prediksiData.bulan.map((b, i) => [
        b,
        window.prediksiData.prediksi[i],
        window.prediksiData.ciBawah[i],
        window.prediksiData.ciAtas[i]
      ]);
      doc.autoTable({ head: [["Bulan", "Prediksi Kasus", "CI Bawah", "CI Atas"]], body: body, startY: 50 });
      doc.save("Prediksi_DBD.pdf");
    }

    function downloadExcel() {
      const ws_data = [["Bulan", "Prediksi Kasus", "CI Bawah", "CI Atas"]];
      window.prediksiData.bulan.forEach((b, i) => {
        ws_data.push([
          b,
          window.prediksiData.prediksi[i],
          window.prediksiData.ciBawah[i],
          window.prediksiData.ciAtas[i]
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Prediksi DBD");
      XLSX.writeFile(wb, "Prediksi_DBD.xlsx");
    }

    function downloadChartImage() {
      const link = document.createElement("a");
      link.href = document.getElementById("chartPrediksi").toDataURL("image/png");
      link.download = "Grafik_Prediksi_DBD.png";
      link.click();
    }
  </script>
</body>
</html>
